name: Deploy SAM Application

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - uses: aws-actions/setup-sam@v2
      
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1
          
      - run: sam build
      
      - name: Package and Deploy via CloudFormation
        run: |
          # 1. Garante que existe um bucket S3 para os artefatos (usando Account ID para ser Ãºnico)
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="api-pokemon-artifacts-${ACCOUNT_ID}"
          aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null || aws s3 mb "s3://$BUCKET_NAME"
          
          # 2. Empacota (Upload para S3) e Deploy (CloudFormation)
          aws cloudformation package --template-file .aws-sam/build/template.yaml --s3-bucket $BUCKET_NAME --output-template-file packaged.yaml
          aws cloudformation deploy --template-file packaged.yaml --stack-name api-pokemon --capabilities CAPABILITY_IAM --no-fail-on-empty-changeset --parameter-overrides OmdbApiKey="${{ secrets.OMDB_API_KEY }}"
